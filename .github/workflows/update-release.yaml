name: Update release with binaries

on:
  push:
    tags:
      - v*

jobs:
  update_release:
      if: github.repository == 'mrmans0n/compose-rules'
      runs-on: ubuntu-latest
      timeout-minutes: 30
      env:
          TERM: dumb

      steps:
          - uses: actions/checkout@v6

          - name: Copy CI gradle.properties
            run: mkdir -p ~/.gradle ; cp .github/ci-gradle.properties ~/.gradle/gradle.properties

          - name: Setup JDK
            uses: actions/setup-java@v5
            with:
                distribution: 'zulu'
                java-version: 24

          - uses: gradle/actions/setup-gradle@v5

          - name: Add artifact version to ENV
            run: echo "VERSION=$(./gradlew -q printVersion)" >> $GITHUB_ENV

          - name: Build the fat jars for CLI usage
            if: success() && !endsWith(env.VERSION, '-SNAPSHOT')
            run: ./gradlew clean :rules:ktlint:shadowJar :rules:detekt:shadowJar -PuberJar --rerun-tasks

          - name: Upload ktlint fat jars binaries to release
            if: success() && !endsWith(env.VERSION, '-SNAPSHOT')
            uses: svenstaro/upload-release-action@v2
            with:
                repo_token: ${{ secrets.GITHUB_TOKEN }}
                file: rules/ktlint/build/libs/ktlint-${{ env.VERSION }}-all.jar
                tag: v${{ env.VERSION }}
                asset_name: ktlint-compose-${{ env.VERSION }}-all.jar
                overwrite: true

          - name: Upload detekt fat jars binaries to release
            if: success() && !endsWith(env.VERSION, '-SNAPSHOT')
            uses: svenstaro/upload-release-action@v2
            with:
                repo_token: ${{ secrets.GITHUB_TOKEN }}
                file: rules/detekt/build/libs/detekt-${{ env.VERSION }}-all.jar
                tag: v${{ env.VERSION }}
                asset_name: detekt-compose-${{ env.VERSION }}-all.jar
                overwrite: true

          - name: Extract dependency versions and update release notes
            if: success() && !endsWith(env.VERSION, '-SNAPSHOT')
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            run: |
                # Parse versions from libs.versions.toml (match only version strings, not plugin definitions)
                DETEKT_VERSION=$(grep '^detekt = "' gradle/libs.versions.toml | sed 's/detekt = "\([^"]*\)".*/\1/')
                KOTLIN_DETEKT_VERSION=$(grep '^kotlin-detekt = "' gradle/libs.versions.toml | sed 's/kotlin-detekt = "\([^"]*\)".*/\1/')
                KTLINT_VERSION=$(grep '^ktlint = "' gradle/libs.versions.toml | sed 's/ktlint = "\([^"]*\)".*/\1/')
                KOTLIN_KTLINT_VERSION=$(grep '^kotlin-ktlint = "' gradle/libs.versions.toml | sed 's/kotlin-ktlint = "\([^"]*\)".*/\1/')

                echo "Detekt: $DETEKT_VERSION (Kotlin $KOTLIN_DETEKT_VERSION)"
                echo "Ktlint: $KTLINT_VERSION (Kotlin $KOTLIN_KTLINT_VERSION)"

                # Get current release body
                RELEASE_ID=$(gh api repos/${{ github.repository }}/releases/tags/v${{ env.VERSION }} --jq '.id')
                CURRENT_BODY=$(gh api repos/${{ github.repository }}/releases/$RELEASE_ID --jq '.body')

                # Check if dependency matrix already exists in the body
                if echo "$CURRENT_BODY" | grep -q "## Dependency Matrix"; then
                    echo "Dependency matrix already exists, skipping update"
                    exit 0
                fi

                # Create the dependency matrix table (using printf for proper newlines)
                DEPENDENCY_TABLE=$(printf "## Dependency Matrix\n\n| version | kotlin version |\n| ------- | -------------- |\n| detekt %s | %s |\n| ktlint %s | %s |" "$DETEKT_VERSION" "$KOTLIN_DETEKT_VERSION" "$KTLINT_VERSION" "$KOTLIN_KTLINT_VERSION")

                # Append the dependency matrix to the release body
                NEW_BODY=$(printf "%s\n\n%s" "$CURRENT_BODY" "$DEPENDENCY_TABLE")

                # Update the release
                gh api repos/${{ github.repository }}/releases/$RELEASE_ID \
                    -X PATCH \
                    -f body="$NEW_BODY"

                echo "Release notes updated with dependency matrix"
