name: Update release

on:
  push:
    branches:
      - main

jobs:
  update_draft_release:
    if: github.repository == 'mrmans0n/compose-rules'
    runs-on: ubuntu-latest
    steps:
      - uses: release-drafter/release-drafter@v6
        id: release_drafter
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/checkout@v6

      - name: Update draft release with dependency matrix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Parse versions from libs.versions.toml
          DETEKT_VERSION=$(grep '^detekt = "' gradle/libs.versions.toml | sed 's/detekt = "\([^"]*\)".*/\1/')
          KOTLIN_DETEKT_VERSION=$(grep '^kotlin-detekt = "' gradle/libs.versions.toml | sed 's/kotlin-detekt = "\([^"]*\)".*/\1/')
          KTLINT_VERSION=$(grep '^ktlint = "' gradle/libs.versions.toml | sed 's/ktlint = "\([^"]*\)".*/\1/')
          KOTLIN_KTLINT_VERSION=$(grep '^kotlin-ktlint = "' gradle/libs.versions.toml | sed 's/kotlin-ktlint = "\([^"]*\)".*/\1/')

          echo "Detekt: $DETEKT_VERSION (Kotlin $KOTLIN_DETEKT_VERSION)"
          echo "Ktlint: $KTLINT_VERSION (Kotlin $KOTLIN_KTLINT_VERSION)"

          # Get current release body from the draft created by release-drafter
          RELEASE_ID="${{ steps.release_drafter.outputs.id }}"
          CURRENT_BODY=$(gh api repos/${{ github.repository }}/releases/$RELEASE_ID --jq '.body')

          # Check if dependency matrix already exists
          if echo "$CURRENT_BODY" | grep -q "## Dependency Matrix"; then
            echo "Dependency matrix already exists, skipping update"
            exit 0
          fi

          # Create the dependency matrix table
          DEPENDENCY_TABLE=$(printf "## Dependency Matrix\n\n| version | kotlin version |\n| ------- | -------------- |\n| detekt %s | %s |\n| ktlint %s | %s |" "$DETEKT_VERSION" "$KOTLIN_DETEKT_VERSION" "$KTLINT_VERSION" "$KOTLIN_KTLINT_VERSION")

          # Append to the release body
          NEW_BODY=$(printf "%s\n\n%s" "$CURRENT_BODY" "$DEPENDENCY_TABLE")

          # Update the draft release
          gh api repos/${{ github.repository }}/releases/$RELEASE_ID \
            -X PATCH \
            -f body="$NEW_BODY"

          echo "Draft release updated with dependency matrix"
